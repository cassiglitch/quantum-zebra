<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Snake</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }
        canvas {
            position: fixed;
            top: 0;
            bottom: 0;
            border: 1px solid #ddd;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let startingGridSize = 20;
        let gridSize = 20;

        function closestNumber(n, m) {
            let q = Math.floor(n / m);
            let n1 = m * q;
            let n2 = m * (q + 1);
            if (n1 > n) return n;
            if (n2 > n) return n1;
            return Math.abs(n - n1) < Math.abs(n - n2) ? n1 : n2;
        }

        function resizeCanvas() {
            const canvasWidth = closestNumber(window.innerWidth, gridSize);
            const canvasHeight = closestNumber(window.innerHeight, gridSize);
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
        }

        let snake = [{ x: 50, y: 300 }];
        let food = { x: Math.random() * (canvas.width - 20), y: Math.random() * (canvas.height - 20) };
        let gravity = 0.5;
        let jumpStrength = 12;
        let isGameOver = false;
        let score = 0;
        let obstacles = [];
        let obstacleFrequency = 90;
        let frameCount = 0;
        let snakeSpeed = 2;

        function jump() {
            if (!isGameOver) {
                snake[0].y -= jumpStrength;
            } else {
                resetGame();
            }
        }

        document.addEventListener('click', jump);
        document.addEventListener('keydown', (event) => {
            if (event.code === 'ArrowUp') {
                jump();
            } else if (event.code === 'ArrowLeft') {
                snake[0].x -= gridSize;
            } else if (event.code === 'ArrowRight') {
                snake[0].x += gridSize;
            } else if (event.code === 'ArrowDown') {
                snake[0].y += gridSize;
            }
        });

        function drawSnake() {
            ctx.fillStyle = 'green';
            snake.forEach(segment => {
                ctx.fillRect(segment.x, segment.y, gridSize, gridSize);
            });
        }

        function drawFood() {
            ctx.fillStyle = 'red';
            ctx.fillRect(food.x, food.y, gridSize, gridSize);
        }

        function drawObstacles() {
            ctx.fillStyle = 'brown';
            obstacles.forEach(obstacle => {
                ctx.fillRect(obstacle.x, obstacle.y, gridSize, obstacle.height);
            });
        }

        function updateSnake() {
            // Move each segment to follow the one before it
            for (let i = snake.length - 1; i > 0; i--) {
                snake[i].x = snake[i - 1].x;
                snake[i].y = snake[i - 1].y;
            }

            // Apply gravity to the head
            snake[0].y += gravity;

            // Check if the snake eats food
            if (snake[0].x < food.x + gridSize && snake[0].x + gridSize > food.x &&
                snake[0].y < food.y + gridSize && snake[0].y + gridSize > food.y) {
                score++;
                // Add a new segment at the tail
                let tail = { ...snake[snake.length - 1] }; // Duplicate the last segment
                snake.push(tail);

                // Relocate the food
                food.x = Math.random() * (canvas.width - gridSize);
                food.y = Math.random() * (canvas.height - gridSize);
            }
        }

        function generateObstacles() {
            if (frameCount % obstacleFrequency === 0) {
                const gap = 100;
                const heightTop = Math.random() * (canvas.height - gap - gridSize);
                obstacles.push({ x: canvas.width, y: 0, height: heightTop });
                obstacles.push({ x: canvas.width, y: heightTop + gap, height: canvas.height - heightTop - gap });
            }

            obstacles.forEach(obstacle => {
                obstacle.x -= snakeSpeed;
            });

            obstacles = obstacles.filter(obstacle => obstacle.x + gridSize > 0);
        }

        function moveFood() {
            food.x -= 2;
            if (food.x < -gridSize) {
                food.x = canvas.width + Math.random() * 100;
                food.y = Math.random() * (canvas.height - gridSize);
            }
        }

        function checkCollision() {
            if (snake[0].y + gridSize > canvas.height || snake[0].y < 0 || snake[0].x < 0 || snake[0].x + gridSize > canvas.width) {
                isGameOver = true;
            }
            obstacles.forEach(obstacle => {
                if (snake[0].x + gridSize > obstacle.x && snake[0].x < obstacle.x + gridSize &&
                    snake[0].y < obstacle.y + obstacle.height && snake[0].y + gridSize > obstacle.y) {
                    isGameOver = true;
                }
            });
        }

        function resetGame() {
            snake = [{ x: 50, y: 300 }];
            food = { x: Math.random() * (canvas.width - gridSize), y: Math.random() * (canvas.height - gridSize) };
            obstacles = [];
            score = 0;
            frameCount = 0;
            isGameOver = false;
            resizeCanvas();
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frameCount++;

            if (!isGameOver) {
                updateSnake();
                generateObstacles();
                moveFood();
                drawSnake();
                drawFood();
                drawObstacles();
                checkCollision();

                ctx.fillStyle = 'black';
                ctx.font = '20px Arial';
                ctx.fillText('Score: ' + score, 10, 20);
            } else {
                ctx.fillStyle = 'black';
                ctx.font = '30px Arial';
                ctx.fillText('Game Over', 100, canvas.height / 2);
                ctx.fillText('Score: ' + score, 130, canvas.height / 2 + 40);
                ctx.fillText('Click or Press Up Arrow to Restart', 30, canvas.height / 2 + 80);
            }

            requestAnimationFrame(gameLoop);
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        gameLoop();
    </script>
</body>
</html>
