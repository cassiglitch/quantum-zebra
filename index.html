<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reality Destabilization</title>
<style>
    body {
        margin: 0;
        overflow: hidden;
    }
    canvas {
        display: block;
    }
</style>
</head>
<body>
<canvas id="crackCanvas"></canvas>
<script src="delaunay.min.js"></script>
<script src="TweenMax.min.js"></script>
<script>
    const TWO_PI = Math.PI * 2;

    var vertices = [],
        indices = [],
        fragments = [];

    var container = document.getElementById('crackCanvas');

    var clickPosition = [container.width * 0.5, container.height * 0.5];

    container.addEventListener('click', imageClickHandler);

    window.onload = function () {
        placeCanvas();
        triangulate();
    };

    function placeCanvas() {
        var canvas = document.createElement('canvas');
        canvas.width = container.offsetWidth;
        canvas.height = container.offsetHeight;
        container.appendChild(canvas);
    }

    function imageClickHandler(event) {
        clickPosition[0] = event.clientX - container.getBoundingClientRect().left;
        clickPosition[1] = event.clientY - container.getBoundingClientRect().top;

        triangulate();
        shatter();
    }

    function triangulate() {
        var rows = 10,
            cols = 10,
            x, y;

        vertices = [];

        for (var i = 0; i < rows; i++) {
            for (var j = 0; j < cols; j++) {
                x = (j / (cols - 1)) * container.width;
                y = (i / (rows - 1)) * container.height;
                vertices.push([x, y]);
            }
        }

        indices = Delaunay.triangulate(vertices);
    }

    function shatter() {
        var p0, p1, p2,
            fragment;

        for (var i = 0; i < indices.length; i += 3) {
            p0 = vertices[indices[i + 0]];
            p1 = vertices[indices[i + 1]];
            p2 = vertices[indices[i + 2]];

            fragment = new Fragment(p0, p1, p2);
            fragment.shatter();
            fragments.push(fragment);
        }
    }

    /////////////
    // FRAGMENT
    /////////////

    function Fragment(v0, v1, v2) {
        this.v0 = v0;
        this.v1 = v1;
        this.v2 = v2;

        this.computeBoundingBox();
        this.createCanvas();
        this.clip();
    }

    Fragment.prototype = {
        computeBoundingBox: function () {
            var xMin = Math.min(this.v0[0], this.v1[0], this.v2[0]),
                xMax = Math.max(this.v0[0], this.v1[0], this.v2[0]),
                yMin = Math.min(this.v0[1], this.v1[1], this.v2[1]),
                yMax = Math.max(this.v0[1], this.v1[1], this.v2[1]);

            this.box = {
                x: xMin,
                y: yMin,
                w: xMax - xMin,
                h: yMax - yMin
            };
        },
        createCanvas: function () {
            this.canvas = document.createElement('canvas');
            this.canvas.width = this.box.w;
            this.canvas.height = this.box.h;
            this.canvas.style.width = this.box.w + 'px';
            this.canvas.style.height = this.box.h + 'px';
            this.canvas.style.position = 'absolute';
            this.canvas.style.left = this.box.x + 'px';
            this.canvas.style.top = this.box.y + 'px';
            this.ctx = this.canvas.getContext('2d');
            container.appendChild(this.canvas);
        },
        clip: function () {
            this.ctx.beginPath();
            this.ctx.moveTo(this.v0[0], this.v0[1]);
            this.ctx.lineTo(this.v1[0], this.v1[1]);
            this.ctx.lineTo(this.v2[0], this.v2[1]);
            this.ctx.closePath();
            this.ctx.clip();
        },
        shatter: function () {
            var dx = this.box.w * 0.5 - clickPosition[0],
                dy = this.box.h * 0.5 - clickPosition[1],
                d = Math.sqrt(dx * dx + dy * dy),
                rx = 30 * sign(dy),
                ry = 90 * -sign(dx),
                delay = d * 0.003 * randomRange(0.9, 1.1);

            var self = this;

            TweenMax.to(this.canvas, 1, {
                x: randomRange(-500, 500),
                y: randomRange(-500, 500),
                rotationX: rx,
                rotationY: ry,
                ease: Cubic.easeIn,
                onComplete: function () {
                    container.removeChild(self.canvas);
                }
            });
        }
    };

    // Math Utils
    function randomRange(min, max) {
        return min + (max - min) * Math.random();
    }

    function sign(x) {
        return x < 0 ? -1 : 1;
    }
</script>
</body>
</html>
